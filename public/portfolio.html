<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Portfolio - Foliage</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .posts { margin-top: 1rem; display: flex; flex-direction: column; gap: 1rem; }
    .post { border: 1px solid #ddd; border-radius: 8px; padding: 1rem; background: #fafafa; }
    .post img { max-width: 100%; border-radius: 8px; }
    .post p { margin-top: 0.5rem; }
    .btn { padding: 0.5rem 1rem; border: none; border-radius: 6px; cursor: pointer; background: #4CAF50; color: white; }
    .btn.small { font-size: 0.9rem; }
    .btn.danger { background: #d9534f; }
    .form-group { margin-top: 1.5rem; }
    input, textarea, select { width: 100%; padding: 0.5rem; margin-top: 0.5rem; border-radius: 6px; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <h2 id="portfolioName">Portfolio</h2>
        <button id="renameBtn" class="btn small">Rename</button>
      </div>
      
      <div>
        <button id="backBtn" class="btn small">Back to Dashboard</button>
        <button id="logoutBtn" class="btn small danger">Logout</button>
      </div>
    </div>

    <div id="postList" class="posts">
      <p>Loading posts...</p>
    </div>

    <div class="form-group">
      <h3>Add New Post</h3>
      <label for="postType">Type:</label>
      <select id="postType">
        <option value="image">Image</option>
        <option value="text">Text</option>
      </select>

      <div id="imageInput">
        <label for="imageUrl">Upload Image:</label>
        <input type="file" accept="image/*" id="imageFile" placeholder="https://example.com/image.jpg">
      </div>

      <div id="textInput" style="display:none;">
        <label for="textBody">Text Content:</label>
        <textarea id="textBody" rows="4" placeholder="Write something..."></textarea>
      </div>

      <button id="createPostBtn" class="btn">Create Post</button>
      <button id="reorderBtn" class="btn">Reorder Posts</button>
      <button id="saveOrderBtn" class="btn" style="display:none;">Save Order</button>
    </div>
  </div>

  <script>
    const API_BASE = "/api";
    const userKey = "foliage_user";

    let reorderMode = false;
    let currentPosts = [];

    // Get info for currently logged in user
    function getCurrentUser() {
      const stored = localStorage.getItem(userKey);
      if (!stored || stored === "undefined") return null;
      try { return JSON.parse(stored); } 
      catch { return null; }
    }

    // Redirect to index if there is no logged in user
    const user = getCurrentUser();
    if (!user || !user.ID) {
      console.warn("No logged in user found, redirecting...");
      window.location.href = "/index.html";
    }

    function getPortfolioId() {
      const params = new URLSearchParams(window.location.search);
      return params.get("id");
    }

    // Display portfolio posts
    function renderPosts() {
      const container = document.getElementById("postList");
      container.innerHTML = "";
      if (!currentPosts.length) {
        container.innerHTML = "<p>No posts yet.</p>";
        return;
      }
      currentPosts.forEach(p => {
        const div = document.createElement("div");
        div.classList.add("post");

        let content = "";
        if (p.type === "image") {
          content = `<img src="${p.image_url}">`;
        } else {
          content = `<p>${p.text_body}</p>`;
        }

        div.innerHTML = `
          ${content}
          <button class="btn small danger" onclick="deletePost(${p.id})">Delete</button>
        `;

        // Allow post reordering when "Reorder Posts" button has been clicked
        if (reorderMode) {
          div.classList.add("reorder-active");
          div.setAttribute("draggable", "true");
          div.style.cursor = "move";

          div.addEventListener("dragstart", e => {
            e.dataTransfer.setData("text/plain", p.id);
          });
          div.addEventListener("dragover", e => e.preventDefault());
          div.addEventListener("drop", e => {
            e.preventDefault();
            const draggedId = parseInt(e.dataTransfer.getData("text/plain"));
            const targetId = p.id;
            reorderPostsLocal(draggedId, targetId);
            renderPosts();
          });
        }

        container.appendChild(div);
      });
    }

    // Get portfolio posts from DB
    async function loadPosts() {
      const portfolioId = getPortfolioId();

      // Get portfolio info
      const portfolioRes = await fetch(`${API_BASE}/portfolio/${portfolioId}`);
      const portfolio = await portfolioRes.json();
      document.getElementById("portfolioName").textContent = portfolio.name;

      // Get posts
      const res = await fetch(`${API_BASE}/portfolio/posts?portfolio_id=${portfolioId}`);
      const posts = await res.json();
      currentPosts = posts;
      const container = document.getElementById("postList");
      container.innerHTML = "";

      if (!Array.isArray(posts) || posts.length === 0) {
        container.innerHTML = "<p>No posts yet.</p>";
        return;
      }

      renderPosts();
    }

    async function createPost() {
      const type = document.getElementById("postType").value;
      const portfolioId = getPortfolioId();

      if (type === "image") {
        // Image post
        const fileInput = document.getElementById("imageFile");
        if (!fileInput.files.length) return alert("Please upload an image.");
        const file = fileInput.files[0];

        // Upload image file
        const formData = new FormData();
        formData.append("file", file);

        const uploadRes = await fetch(`${API_BASE}/post/upload`, {
          method: "POST",
          body: formData
        });

        if (!uploadRes.ok) return alert("Failed to upload image.");

        const uploaded = await uploadRes.json();

        // Create post with the uploaded URL
        const payload = {
          user_id: user.ID,
          portfolio_id: parseInt(portfolioId),
          post_type: "image",
          image_url: uploaded.url
        };

        // Send img post to DB
        const res = await fetch(`${API_BASE}/post/image`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!res.ok) return alert("Failed to create post.");
      } else {
        // Text post
        const textBody = document.getElementById("textBody").value.trim();
        if (!textBody) return alert("Post cannot be blank.");

        const payload = {
          user_id: user.ID,
          portfolio_id: parseInt(portfolioId),
          post_type: "text",
          text_body: textBody
        };

        // Send text post to DB
        const res = await fetch(`${API_BASE}/post/text`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!res.ok) return alert("Failed to create post.");
      }

      // Clear inputs
      document.getElementById("textBody").value = "";
      document.getElementById("imageFile").value = "";

      loadPosts(); // reload posts
    }

    // Remove a specific post from the DB
    async function deletePost(postId) {
      if (!confirm("Are you sure you want to delete this post?")) return;

      const res = await fetch(`${API_BASE}/post/${postId}`, {
        method: "DELETE",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_id: user.ID })
      });

      if (res.ok) {
        document.querySelector(`button[onclick="deletePost(${postId})"]`).parentElement.remove();
      } else {
        const err = await res.json().catch(() => ({}));
        alert("Failed to delete post: " + (err.error || res.statusText));
      }
    }

    function reorderPostsLocal(draggedId, targetId) {
      const fromIndex = currentPosts.findIndex(p => p.id === draggedId);
      const toIndex = currentPosts.findIndex(p => p.id === targetId);
      const [moved] = currentPosts.splice(fromIndex, 1);
      currentPosts.splice(toIndex, 0, moved);
    }

    // Button to switch reorder mode on and off
    document.getElementById("reorderBtn").addEventListener("click", () => {
      reorderMode = !reorderMode;
      document.getElementById("saveOrderBtn").style.display = reorderMode ? "inline-block" : "none";
      document.getElementById("reorderBtn").style.display = reorderMode ? "none" : "inline-block";
      renderPosts();
    });

    // Save button active when in reorder mode
    document.getElementById("saveOrderBtn").addEventListener("click", async () => {
      const postIDs = currentPosts.map(p => p.id);
      const portfolioId = parseInt(getPortfolioId());
      const res = await fetch(`${API_BASE}/post/reorder`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ portfolio_id: portfolioId, post_ids: postIDs })
      });
      if (res.ok) {
        alert("Order saved!");
      } else {
        alert("Failed to save order.");
      }

      reorderMode = !reorderMode;
      document.getElementById("saveOrderBtn").style.display = reorderMode ? "inline-block" : "none";
      document.getElementById("reorderBtn").style.display = reorderMode ? "none" : "inline-block";
      loadPosts();
    });

    // Switch between image input and text input
    document.getElementById("postType").addEventListener("change", e => {
      document.getElementById("imageInput").style.display = e.target.value === "image" ? "block" : "none";
      document.getElementById("textInput").style.display = e.target.value === "text" ? "block" : "none";
    });

    document.getElementById("createPostBtn").addEventListener("click", createPost);
    document.getElementById("logoutBtn").addEventListener("click", () => { localStorage.removeItem(userKey); window.location.href = "/index.html"; });
    document.getElementById("backBtn").addEventListener("click", () => window.location.href = "/dashboard.html");

    // Rename portfolio
    document.getElementById("renameBtn").addEventListener("click", async () => {
    const portfolioId = getPortfolioId();
    const currentName = document.getElementById("portfolioName").textContent;
    const newName = prompt("Enter a new portfolio name:", currentName);

    if (!newName || newName.trim() === "" || newName === currentName) return;

    // Send new portfolio name to DB
    const res = await fetch(`${API_BASE}/portfolio/${portfolioId}/rename`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ new_name: newName })
    });

    if (res.ok) {
      const updated = await res.json();
      document.getElementById("portfolioName").textContent = updated.name;
      alert("Portfolio renamed successfully!");
    } else {
      const err = await res.json().catch(() => ({}));
      alert("Failed to rename portfolio: " + (err.error || res.statusText));
    }
  });
    loadPosts();
  </script>
</body>
</html>
