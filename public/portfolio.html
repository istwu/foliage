<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Portfolio - Foliage</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .posts { margin-top: 1rem; display: flex; flex-direction: column; gap: 1rem; }
    .post { border: 1px solid #ddd; border-radius: 8px; padding: 1rem; background: #fafafa; }
    .post img { max-width: 100%; border-radius: 8px; }
    .post p { margin-top: 0.5rem; }
    .btn { padding: 0.5rem 1rem; border: none; border-radius: 6px; cursor: pointer; background: #4CAF50; color: white; }
    .btn.small { font-size: 0.9rem; }
    .btn.danger { background: #d9534f; }
    .form-group { margin-top: 1.5rem; }
    input, textarea, select { width: 100%; padding: 0.5rem; margin-top: 0.5rem; border-radius: 6px; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h2 id="portfolioName">Portfolio</h2>
      <div>
        <button id="backBtn" class="btn small">Back to Dashboard</button>
        <button id="logoutBtn" class="btn small danger">Logout</button>
      </div>
    </div>

    <div id="postList" class="posts">
      <p>Loading posts...</p>
    </div>

    <div class="form-group">
      <h3>Add New Post</h3>
      <label for="postType">Type:</label>
      <select id="postType">
        <option value="image">Image</option>
        <option value="text">Text</option>
      </select>

      <div id="imageInput">
        <label for="imageUrl">Upload Image:</label>
        <input type="file" accept="image/*" id="imageFile" placeholder="https://example.com/image.jpg">
      </div>

      <div id="textInput" style="display:none;">
        <label for="textBody">Text Content:</label>
        <textarea id="textBody" rows="4" placeholder="Write something..."></textarea>
      </div>

      <button id="createPostBtn" class="btn">Create Post</button>
    </div>
  </div>

  <script>
    const API_BASE = "/api";
    const userKey = "foliage_user";

    function getCurrentUser() {
      const stored = localStorage.getItem(userKey);
      if (!stored || stored === "undefined") return null;
      try { return JSON.parse(stored); } 
      catch { return null; }
    }

    const user = getCurrentUser();
    if (!user || !user.ID) {
      console.warn("No logged in user found, redirecting...");
      window.location.href = "/index.html";
    }

    function getPortfolioId() {
      const params = new URLSearchParams(window.location.search);
      return params.get("id");
    }

    async function loadPosts() {
      const portfolioId = getPortfolioId();

      // Get portfolio info
      const portfolioRes = await fetch(`${API_BASE}/portfolio/${portfolioId}`);
      const portfolio = await portfolioRes.json();
      document.getElementById("portfolioName").textContent = portfolio.name;

      // Get posts
      const res = await fetch(`${API_BASE}/portfolio/posts?portfolio_id=${portfolioId}`);
      const posts = await res.json();
      const container = document.getElementById("postList");
      container.innerHTML = "";

      if (!Array.isArray(posts) || posts.length === 0) {
        container.innerHTML = "<p>No posts yet.</p>";
        return;
      }

      posts.forEach(p => {
        const div = document.createElement("div");
        div.classList.add("post");

        let content = "";
        if (p.type === "image") {
          content = `<img src="${p.image_url}">`;
        } else {
          content = `<p>${p.text_body}</p>`;
        }

        div.innerHTML = `
          ${content}
          <button class="btn small danger" onclick="deletePost(${p.id})">Delete</button>
        `;

        container.appendChild(div);
      });
    }

    async function createPost() {
      const type = document.getElementById("postType").value;
      const portfolioId = getPortfolioId();

      if (type === "image") {
        // Image post
        const fileInput = document.getElementById("imageFile");
        if (!fileInput.files.length) return alert("Please upload an image.");
        const file = fileInput.files[0];

        // Step 1: Upload the file
        const formData = new FormData();
        formData.append("file", file);

        const uploadRes = await fetch(`${API_BASE}/post/upload`, {
          method: "POST",
          body: formData
        });

        if (!uploadRes.ok) return alert("Failed to upload image.");

        const uploaded = await uploadRes.json();
        // 'uploaded.url' should be the path returned by your server (e.g., "/uploads/abc.jpg")

        // Step 2: Create post with the uploaded URL
        const payload = {
          user_id: user.ID,
          portfolio_id: parseInt(portfolioId),
          post_type: "image",
          image_url: uploaded.url
        };

        const res = await fetch(`${API_BASE}/post/image`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!res.ok) return alert("Failed to create post.");
      } else {
        // Text post
        const textBody = document.getElementById("textBody").value.trim();
        if (!textBody) return alert("Post cannot be blank.");

        const payload = {
          user_id: user.ID,
          portfolio_id: parseInt(portfolioId),
          post_type: "text",
          text_body: textBody
        };

        const res = await fetch(`${API_BASE}/post/text`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!res.ok) return alert("Failed to create post.");
      }

      // Clear inputs
      document.getElementById("textBody").value = "";
      document.getElementById("imageFile").value = "";

      loadPosts(); // reload posts
    }

    async function deletePost(postId) {
      if (!confirm("Are you sure you want to delete this post?")) return;

      const res = await fetch(`${API_BASE}/post/${postId}`, {
        method: "DELETE",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_id: user.ID })
      });

      if (res.ok) {
        document.querySelector(`button[onclick="deletePost(${postId})"]`).parentElement.remove();
      } else {
        const err = await res.json().catch(() => ({}));
        alert("Failed to delete post: " + (err.error || res.statusText));
      }
    }


    document.getElementById("postType").addEventListener("change", e => {
      document.getElementById("imageInput").style.display = e.target.value === "image" ? "block" : "none";
      document.getElementById("textInput").style.display = e.target.value === "text" ? "block" : "none";
    });

    document.getElementById("createPostBtn").addEventListener("click", createPost);
    document.getElementById("logoutBtn").addEventListener("click", () => { localStorage.removeItem(userKey); window.location.href = "/index.html"; });
    document.getElementById("backBtn").addEventListener("click", () => window.location.href = "/dashboard.html");

    loadPosts();
  </script>
</body>
</html>
